<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Qu·∫£n L√Ω Chi Ti√™u</title>
  <meta name="theme-color" content="#7a2a1a" />
  <!-- Font vui t∆∞∆°i -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
  <!-- App icons -->
  <link rel="apple-touch-icon" href="assets/mascot/tiger_logo.png" />
  <link rel="icon" href="assets/mascot/tiger_logo.png" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root{
      /* T√¥ng ƒë·ªè n√¢u (gi·ªØ nguy√™n) */
      --primary:#8B2E1A; --primary-600:#7A2A1A; --primary-700:#662316; --primary-50:#F7E9E6;
      --bg:#f6f4f3; --surface:#ffffff; --text:#231815; --muted:#8a7975; --danger:#b3261e; --ok:#2e7d32; --ring:#e9d2cd;
      --radius:18px; --shadow:0 10px 30px rgba(139,46,26,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: 'Baloo 2', 'Quicksand', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif; color:var(--text);
      background: radial-gradient(1200px 600px at 10% -10%, var(--primary-50), transparent), var(--bg);
      padding-top: calc(env(safe-area-inset-top) + 0px); padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right);
    }
    input, select, textarea{ font-size:16px; }
    .container{max-width:1160px; padding:24px; margin:0 auto}

    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px}
    .title{display:flex; align-items:center; gap:10px}
    .logo{width:36px; height:36px; border-radius:10px; background:#fff url('assets/mascot/tiger_logo.png') center/cover no-repeat; box-shadow:var(--shadow)}
    h1{font-size:24px; margin:0}

    .grid{ display:grid; gap:16px; grid-template-columns: 1fr; grid-auto-rows:minmax(180px,auto); }
    @media (min-width: 980px){ .grid{ grid-template-columns: 1.1fr 1fr; } }

    .card{background:var(--surface); border:1px solid var(--ring); border-radius:var(--radius); box-shadow:var(--shadow)}
    .card .card-body{padding:18px}
    .card h2{font-size:18px; margin:0 0 12px;}

    .actions{display:flex; flex-wrap:wrap; gap:10px}
    .btn{appearance:none; border:none; cursor:pointer; padding:12px 14px; border-radius:14px; font-weight:700}
    .btn.primary{background:var(--primary); color:#fff}
    .btn.ghost{background:#fff; color:var(--primary-700); border:1px solid var(--ring)}
    .btn.danger{background:var(--danger); color:#fff}
    .btn.icon{display:inline-flex; align-items:center; gap:8px}

    /* Form */
    .form-grid{display:grid; gap:12px}
    @media (min-width:480px){ .form-grid{grid-template-columns: 1fr 1fr} }
    label{font-size:13px; color:var(--muted)}
    input, select, textarea{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--ring); outline:none; background:#fff; }

    /* KPIs */
    .kpis{display:grid; grid-template-columns: repeat(3,1fr); gap:10px}
    .kpi{background:#fff; border:1px solid var(--ring); border-radius:14px; padding:12px; text-align:center}
    .kpi h4{margin:0 0 4px; font-size:12px; color:var(--muted)}
    .kpi .val{font-weight:800; font-size:20px}

    /* List */
    .list{display:flex; flex-direction:column; gap:10px}
    .tx{display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px; padding:12px; background:#fff; border:1px solid var(--ring); border-radius:14px; touch-action: pan-y}
    .tx .date{font-size:12px; color:var(--muted)}
    .tx .cat{font-weight:700}
    .amt{font-weight:800}
    .amt.out{color:var(--danger)}
    .amt.in{color:var(--ok)}

    /* Chart */
    .chart-controls{display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px}
    .chart-box{height:320px; position:relative; width:100%}
    .chart-box canvas{position:absolute; inset:0; width:100%; height:100%}

    /* Mascots */
    .mascot-center{ text-align:center; margin:16px 0; }
    .mascot-center img{ width:100px; height:100px; object-fit:contain; image-rendering:auto }

  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <div class="logo" aria-label="Tiger logo"></div>
        <h1>Qu·∫£n L√Ω Chi Ti√™u</h1>
      </div>
      <div class="actions">
        <button id="exportCSV" class="btn ghost icon" title="Xu·∫•t CSV">üìÑ Xu·∫•t CSV</button>
        <button id="clearAll" class="btn danger icon" title="X√≥a t·∫•t c·∫£ d·ªØ li·ªáu">üóëÔ∏è X√≥a t·∫•t c·∫£</button>
      </div>
    </header>

    <section class="grid">
      <!-- Form -->
      <div class="card">
        <div class="card-body">
          <h2>Th√™m kho·∫£n thu/chi</h2>
          <div class="mascot-center"><img src="assets/mascot/tiger_logo.png" alt="Mascot form" width="100" height="100"/></div>
          <div class="form-grid">
            <div>
              <label for="txDate">Ng√†y</label>
              <input id="txDate" type="date" />
            </div>
            <div>
              <label for="type">Lo·∫°i</label>
              <select id="type">
                <option value="income">Thu (+)</option>
                <option value="expense">Chi (-)</option>
              </select>
            </div>
            <div>
              <label for="category">Danh m·ª•c</label>
              <input id="category" list="categories" placeholder="VD: ƒÇn u·ªëng" />
              <datalist id="categories">
                <option value="ƒÇn u·ªëng"></option>
                <option value="ƒêi l·∫°i"></option>
                <option value="H√≥a ƒë∆°n"></option>
                <option value="Mua s·∫Øm"></option>
                <option value="Gi·∫£i tr√≠"></option>
                <option value="Gi√°o d·ª•c"></option>
                <option value="S·ª©c kh·ªèe"></option>
                <option value="Nh√† c·ª≠a"></option>
                <option value="Gia ƒë√¨nh"></option>
                <option value="Kh√°c"></option>
              </datalist>
            </div>
            <div>
              <label for="amount">S·ªë ti·ªÅn (ƒë)</label>
              <input id="amount" type="text" inputmode="numeric" placeholder="VD: 456.456" />
            </div>
            <div style="grid-column:1/-1">
              <label for="note">Ghi ch√∫</label>
              <textarea id="note" placeholder="(t√πy ch·ªçn)"></textarea>
            </div>
          </div>
          <div style="display:flex; gap:10px; margin-top:12px">
            <button id="add" class="btn primary">Th√™m</button>
            <button id="clearAll2" class="btn ghost">X√≥a t·∫•t c·∫£</button>
          </div>
        </div>
      </div>

      <!-- T·ªïng k·∫øt th√°ng + mascot balance -->
      <div class="card">
        <div class="card-body">
          <h2>T·ªïng k·∫øt th√°ng</h2>
          <div class="chart-controls">
            <label for="filterMonth" style="font-size:13px; color:var(--muted)">Ch·ªçn th√°ng</label>
            <input id="filterMonth" type="month" class="btn ghost" />
            <span id="txCount" style="margin-left:auto; font-size:13px; color:var(--muted)"></span>
          </div>
          <div class="mascot-center">
            <img id="mascotBalance" src="assets/mascot/tiger_rich.png" alt="Mascot balance" />
          </div>
          <div class="kpis">
            <div class="kpi"><h4>T·ªïng Thu</h4><div class="val" id="sumIncome">0</div></div>
            <div class="kpi"><h4>T·ªïng Chi</h4><div class="val" id="sumExpense">0</div></div>
            <div class="kpi"><h4>S·ªë D∆∞</h4><div class="val" id="sumBalance">0</div></div>
          </div>
        </div>
      </div>

      <!-- Danh s√°ch -->
      <div class="card">
        <div class="card-body">
          <h2>Danh s√°ch giao d·ªãch</h2>
          <div id="listHolder" class="list"></div>
          <div id="emptyState" class="tx" style="display:none; justify-content:center; color:var(--muted)">Ch∆∞a c√≥ giao d·ªãch n√†o.</div>
        </div>
      </div>

      <!-- Bi·ªÉu ƒë·ªì + mascot minh ho·∫° -->
      <div class="card">
        <div class="card-body">
          <h2>Bi·ªÉu ƒë·ªì</h2>
          <div class="mascot-center"><img id="mascotChart" src="assets/mascot/tiger_spending.png" alt="Mascot chart"/></div>
          <div class="chart-controls">
            <select id="chartMode" class="btn ghost">
              <option value="byCategory">Theo danh m·ª•c (Chi)</option>
              <option value="totals">T·ªïng Thu vs Chi</option>
            </select>
            <select id="chartType" class="btn ghost">
              <option value="doughnut">Donut</option>
              <option value="bar">C·ªôt</option>
              <option value="line">ƒê∆∞·ªùng th·∫≥ng</option>
            </select>
          </div>
          <div class="chart-box">
            <canvas id="chart"></canvas>
          </div>
          <div id="chartLegend" style="margin-top:8px; font-size:13px; color:var(--muted)"></div>
        </div>
      </div>

    </section>

    <footer>
      <span>PWA offline ¬∑ L∆∞u d·ªØ li·ªáu tr√™n thi·∫øt b·ªã c·ªßa b·∫°n.</span>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const $ = (s)=>document.querySelector(s);

    // Elements
    const listHolder = $('#listHolder');
    const emptyState = $('#emptyState');
    const sumIncomeEl = $('#sumIncome');
    const sumExpenseEl = $('#sumExpense');
    const sumBalanceEl = $('#sumBalance');
    const chartEl = $('#chart');
    const chartTypeSel = $('#chartType');
    const chartModeSel = $('#chartMode');
    const chartLegend = $('#chartLegend');

    const mascotBalance = $('#mascotBalance');
    const mascotChart = $('#mascotChart');

    const txDateEl = $('#txDate');
    const filterMonthEl = $('#filterMonth');
    const txCountEl = $('#txCount');

    let chart; let gestureBound=false;

    const STORAGE_KEY = 'mm_transactions_v1';
    const ASSET = 'assets/mascot/';

    function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [] }catch{ return [] } }
    function save(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)) }

    function vnNumberFormat(n){ return Number(n||0).toLocaleString('vi-VN'); }

    // Format s·ªë ti·ªÅn khi nh·∫≠p
    const amountInput = $('#amount');
    amountInput.addEventListener('input', ()=>{
      const digits = amountInput.value.replace(/\D/g, '');
      amountInput.value = digits ? Number(digits).toLocaleString('vi-VN') : '';
    });
    function parseAmountField(){ return Number((amountInput.value||'').replace(/\D/g,'')||0); }

    // Helpers ng√†y
    const ymd = (ts)=>{ const d=new Date(ts); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` };
    const ym = (ts)=>{ const d=new Date(ts); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}` };
    function applyMonthFilter(arr){ const v = filterMonthEl.value; if(!v) return arr; return arr.filter(t => ym(t.createdAt||Date.now()) === v); }

    // B·∫£ng m√†u t∆∞∆°i cho chart
    function palette(n){
      const base=['#b3261e','#2e7d32','#7A2A1A','#8B2E1A','#ff8f00','#1565c0','#6a1b9a','#00897b','#c2185b','#455a64','#ef6c00','#5d4037','#8e24aa','#43a047','#1e88e5'];
      const out=[]; for(let i=0;i<n;i++){ out.push(base[i%base.length]); } return out;
    }

    function updateMascots(income, expense){
      const balance = income - expense;
      // 1) Mascot theo s·ªë d∆∞
      let pick = 'tiger_logo.png';
      if(balance > 0){ pick = 'tiger_rich.png'; }
      else if(balance < 0){ pick = 'tiger_poor.png'; }
      else { pick = 'tiger_income.png'; }
      if(mascotBalance) mascotBalance.src = ASSET + pick;

      // 2) Mascot ·ªü khu bi·ªÉu ƒë·ªì theo ch·∫ø ƒë·ªô
      if(mascotChart){ mascotChart.src = ASSET + (chartModeSel.value==='byCategory' ? 'tiger_spending.png' : 'tiger_income.png'); }
    }

    function render(){
      // ƒë·∫£m b·∫£o createdAt
      const up = load().map(t=>({...t, createdAt: t.createdAt || Date.now()}));
      save(up);
      const data = applyMonthFilter(up);

      // t·ªïng h·ª£p
      let income=0, expense=0; listHolder.innerHTML='';
      emptyState.style.display = data.length? 'none':'flex';
      txCountEl.textContent = `${data.length} giao d·ªãch`;

      for(const t of data){
        if(t.type==='income') income+= +t.amount||0; else expense+= +t.amount||0;
        const row = document.createElement('div'); row.className='tx'; row.dataset.id=t.id;
        const left = document.createElement('div'); left.innerHTML = `<div class="date">${ymd(t.createdAt)}</div><div class="cat">${t.category||'Kh√°c'}</div>`;
        const amt = document.createElement('div'); amt.className = 'amt ' + (t.type==='income'?'in':'out'); amt.textContent = (t.type==='income'?'+':'-') + vnNumberFormat(t.amount) + 'ƒë';
        const del = document.createElement('button'); del.className='btn danger'; del.textContent='X'; del.onclick=()=>removeOne(t.id);
        row.appendChild(left); row.appendChild(amt); row.appendChild(del); listHolder.appendChild(row);
      }

      sumIncomeEl.textContent = vnNumberFormat(income)+'ƒë';
      sumExpenseEl.textContent = vnNumberFormat(expense)+'ƒë';
      sumBalanceEl.textContent = vnNumberFormat(income-expense)+'ƒë';

      updateMascots(income, expense);
      renderChart(data, income, expense);
      bindGestures();
    }

    function renderChart(data, income, expense){
      if(chart){ chart.destroy(); }
      const type = chartTypeSel.value; const mode = chartModeSel.value;
      let labels=[], values=[], legendText='';
      if(mode==='totals'){
        labels=['Thu','Chi']; values=[income, expense]; legendText='T·ªïng h·ª£p thu/chi';
      } else {
        const map=new Map();
        for(const t of data){ if(t.type!=='expense') continue; const k=t.category||'Kh√°c'; map.set(k,(map.get(k)||0)+(+t.amount||0)); }
        labels=[...map.keys()]; values=[...map.values()]; legendText='Chi ti√™u theo danh m·ª•c';
      }
      const colors = palette(values.length||2);
      const dataset = { label: legendText, data: values,
        backgroundColor: (type==='doughnut' || type==='bar')? colors: undefined,
        borderColor: type==='line'? colors: undefined,
        fill: type==='line'? false: undefined, borderWidth:2, tension: type==='line'? .3: undefined };
      chart = new Chart(chartEl,{ type, data:{labels, datasets:[dataset]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:type==='doughnut'?'bottom':'top' }}, scales:(type==='bar'||type==='line')?{ y:{ beginAtZero:true } }:undefined }});
      chartLegend.textContent = legendText;
    }

    // Gestures (long-press / swipe-left)
    function bindGestures(){ if(gestureBound) return; gestureBound=true; let longPressTimer=null; let startX=0, currentX=0, draggingRow=null;
      function onTouchStart(e){ const row=e.target.closest('.tx'); if(!row) return; draggingRow=row; startX=e.touches[0].clientX; currentX=startX; row.style.transition='none'; longPressTimer=setTimeout(()=>{ clearTimeout(longPressTimer); longPressTimer=null; const id=row.dataset.id; if(!id) return; if(confirm('S·ª≠a giao d·ªãch n√†y? (OK = S·ª≠a, Cancel = X√≥a)')){ editOne(id); } else { if(confirm('X√°c nh·∫≠n x√≥a giao d·ªãch?')) removeOne(id); } },550); }
      function onTouchMove(e){ if(!draggingRow) return; currentX=e.touches[0].clientX; const dx=Math.min(0, currentX-startX); draggingRow.style.transform=`translateX(${dx}px)`; if(Math.abs(dx)>10 && longPressTimer){ clearTimeout(longPressTimer); longPressTimer=null; } }
      function onTouchEnd(){ if(!draggingRow) return; const dx=currentX-startX; draggingRow.style.transition='transform .2s ease'; if(dx<-80){ const id=draggingRow.dataset.id; draggingRow.style.transform='translateX(-120%)'; setTimeout(()=>{ if(id) removeOne(id); },180); } else { draggingRow.style.transform='translateX(0)'; } draggingRow=null; if(longPressTimer){ clearTimeout(longPressTimer); longPressTimer=null; } }
      document.addEventListener('touchstart', onTouchStart, {passive:true});
      document.addEventListener('touchmove', onTouchMove, {passive:true});
      document.addEventListener('touchend', onTouchEnd, {passive:true});
    }

    function removeOne(id){ const data = load().filter(t=>t.id!==id); save(data); render(); }

    function editOne(id){ const data=load(); const i=data.findIndex(t=>t.id===id); if(i<0) return; const t=data[i];
      const amount = prompt('S·ªë ti·ªÅn (ƒë):', String(t.amount)); if(amount===null) return; const category = prompt('Danh m·ª•c:', t.category||''); if(category===null) return;
      const type = prompt('Lo·∫°i: income ho·∫∑c expense', t.type); if(type===null) return; const note = prompt('Ghi ch√∫:', t.note||'');
      const parsed = Number(String(amount).replace(/\D/g,'')); data[i] = {...t, amount: isNaN(parsed)?t.amount:parsed, category, type: (type==='income'?'income':'expense'), note}; save(data); render(); }

    function add(){
      const amount = parseAmountField(); const type=$('#type').value; const category=($('#category').value||'').trim(); const note=($('#note').value||'').trim(); const dateVal=txDateEl.value; if(!amount){ alert('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá'); return }
      const createdAt = dateVal ? new Date(dateVal + 'T00:00:00').getTime() : Date.now();
      const data = load(); data.unshift({ id: crypto.randomUUID(), amount, type, category, note, createdAt }); save(data);
      $('#amount').value=''; $('#category').value=''; $('#note').value=''; render();
    }

    $('#add').addEventListener('click', add);
    $('#clearAll').addEventListener('click', ()=>{ if(confirm('X√≥a t·∫•t c·∫£ giao d·ªãch?')){ localStorage.removeItem(STORAGE_KEY); render(); }});
    $('#clearAll2').addEventListener('click', ()=>{ if(confirm('X√≥a t·∫•t c·∫£ giao d·ªãch?')){ localStorage.removeItem(STORAGE_KEY); render(); }});
    chartTypeSel.addEventListener('change', ()=>{ updateMascots(Number(sumIncomeEl.textContent.replace(/\D/g,'')), Number(sumExpenseEl.textContent.replace(/\D/g,''))); render(); });
    chartModeSel.addEventListener('change', ()=>{ updateMascots(Number(sumIncomeEl.textContent.replace(/\D/g,'')), Number(sumExpenseEl.textContent.replace(/\D/g,''))); render(); });
    filterMonthEl.addEventListener('change', render);

    // CSV theo th√°ng ƒëang ch·ªçn
    $('#exportCSV').addEventListener('click', ()=>{
      const up = load().map(t=>({...t, createdAt: t.createdAt || Date.now()}));
      const data = applyMonthFilter(up);
      const rows = [['type','amount','category','note','createdAt'], ...data.map(t=>[t.type,t.amount,(t.category||'').replaceAll(',', ' '),(t.note||'').replaceAll('\n',' ').replaceAll(',', ' '), new Date(t.createdAt).toISOString()])];
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='moneymoney.csv'; a.click(); URL.revokeObjectURL(url);
    });

    if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }

    (function init(){ const today=new Date(); const yyyy=today.getFullYear(); const mm=String(today.getMonth()+1).padStart(2,'0'); const dd=String(today.getDate()).padStart(2,'0'); $('#txDate').value = `${yyyy}-${mm}-${dd}`; filterMonthEl.value = `${yyyy}-${mm}`; render(); })();
  </script>
</body>
</html>
