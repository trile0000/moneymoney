<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Qu·∫£n L√Ω Chi Ti√™u</title>
  <meta name="theme-color" content="#7a2a1a" />
  <link rel="apple-touch-icon" href="public/assets/mascot/tiger_logo.png" />
  <link rel="icon" href="public/assets/mascot/tiger_logo.png" />
  <link rel="manifest" href="manifest.json" />

  <!-- Font vui t∆∞∆°i -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

  <style>
    :root{ --primary:#8B2E1A; --primary-600:#7A2A1A; --primary-700:#662316; --primary-50:#F7E9E6; --bg:#f6f4f3; --surface:#ffffff; --text:#231815; --muted:#8a7975; --danger:#b3261e; --ok:#2e7d32; --ring:#e9d2cd; --radius:18px; --shadow:0 10px 30px rgba(139,46,26,.08); }
    *{box-sizing:border-box}
    body{ margin:0; font-family:'Baloo 2','Quicksand',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background: radial-gradient(1200px 600px at 10% -10%, var(--primary-50), transparent), var(--bg); color:var(--text); }
    .container{max-width:1160px; padding:24px; margin:0 auto}
    header{display:flex; align-items:center; justify-content:space-between; margin-bottom:18px}
    .title{display:flex; align-items:center; gap:10px}
    .logo{width:36px; height:36px; border-radius:10px; background:#fff url('public/assets/mascot/tiger_logo.png') center/cover no-repeat; box-shadow:var(--shadow)}
    h1{font-size:24px; margin:0}
    .grid{display:grid; gap:16px; grid-template-columns:1fr}
    @media(min-width:980px){.grid{grid-template-columns:1.1fr 1fr}}
    .card{background:var(--surface); border:1px solid var(--ring); border-radius:var(--radius); box-shadow:var(--shadow)}
    .card-body{padding:18px}
    .card h2{margin:0 0 12px}
    .btn{padding:12px 14px; border:none; border-radius:14px; font-weight:700; cursor:pointer}
    .btn.primary{background:var(--primary); color:#fff}
    .btn.ghost{background:#fff; color:var(--primary-700); border:1px solid var(--ring)}
    .btn.danger{background:var(--danger); color:#fff}
    .form-grid{display:grid; gap:12px}
    @media(min-width:480px){.form-grid{grid-template-columns:1fr 1fr}}
    input,select,textarea{width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--ring)}
    .kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    .kpi{background:#fff; border:1px solid var(--ring); border-radius:14px; padding:12px; text-align:center}
    .kpi .val{font-weight:800; font-size:20px}
    .list{display:flex; flex-direction:column; gap:10px}
    .tx{display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px; padding:12px; background:#fff; border:1px solid var(--ring); border-radius:14px}
    .amt.in{color:var(--ok)} .amt.out{color:var(--danger)}
    .chart-box{height:320px; position:relative}
    .chart-box canvas{position:absolute; inset:0; width:100%; height:100%}
    .mascot-center{text-align:center; margin:16px 0}
    .mascot-center img{width:100px; height:100px; object-fit:contain}
    .status-bar{display:flex; justify-content:center; gap:8px; padding:10px; border:1px solid var(--ring); border-radius:12px; font-weight:700}
    .status--rich{background:#e8f5e9; color:#1b5e20}
    .status--poor{background:#fdecea; color:#b3261e}
    .status--neutral{background:#fff8e1; color:#6d4c41}
    @keyframes pop{0%{transform:scale(.9)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
    .mascot-animate{animation:pop .6s}
    .toast{position:fixed; bottom:24px; left:50%; transform:translateX(-50%); background:#1b5e20; color:#fff; padding:10px 14px; border-radius:12px; display:none; font-weight:700}
    .toast.show{display:block}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title"><div class="logo"></div><h1>Qu·∫£n L√Ω Chi Ti√™u</h1></div>
      <div class="actions">
        <button id="clearAll" class="btn danger">üóëÔ∏è X√≥a t·∫•t c·∫£</button>
      </div>
    </header>

    <section class="grid">
      <!-- Form -->
      <div class="card"><div class="card-body">
        <h2>Th√™m kho·∫£n thu/chi</h2>
        <div class="form-grid">
          <div><label>Ng√†y</label><input id="txDate" type="date"/></div>
          <div><label>Lo·∫°i</label><select id="type"><option value="income">Thu</option><option value="expense">Chi</option></select></div>
          <div><label>Danh m·ª•c</label><input id="category"/></div>
          <div><label>S·ªë ti·ªÅn</label><input id="amount" type="text" inputmode="numeric"/></div>
        </div>
        <div style="margin-top:12px"><button id="add" class="btn primary">Th√™m</button></div>
      </div></div>

      <!-- T·ªïng k·∫øt -->
      <div class="card"><div class="card-body">
        <h2>T·ªïng k·∫øt th√°ng</h2>
        <div class="mascot-center"><img id="mascotBalance" src="public/assets/mascot/tiger_logo.png"/></div>
        <div id="balanceStatus" class="status-bar status--neutral">üôÇ C√¢n b·∫±ng</div>
        <div class="kpis">
          <div class="kpi"><h4>Thu</h4><div id="sumIncome" class="val">0</div></div>
          <div class="kpi"><h4>Chi</h4><div id="sumExpense" class="val">0</div></div>
          <div class="kpi"><h4>S·ªë d∆∞</h4><div id="sumBalance" class="val">0</div></div>
        </div>
      </div></div>

      <!-- Danh s√°ch -->
      <div class="card"><div class="card-body">
        <h2>Danh s√°ch</h2>
        <div id="listHolder" class="list"></div>
        <div id="emptyState" style="text-align:center;color:var(--muted)">Ch∆∞a c√≥ giao d·ªãch</div>
      </div></div>

      <!-- Bi·ªÉu ƒë·ªì -->
      <div class="card"><div class="card-body">
        <h2>Bi·ªÉu ƒë·ªì</h2>
        <div class="chart-box"><canvas id="chart"></canvas></div>
        <div id="chartLegend" style="margin-top:8px;color:var(--muted)"></div>
      </div></div>
    </section>
  </div>

  <div id="appToast" class="toast">ƒê√£ l∆∞u</div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const $ = (s)=>document.querySelector(s);
  const STORAGE_KEY = 'mm_transactions_v1';
  const SETTINGS_KEY = 'mm_settings_v1';
  const ASSET = 'public/assets/mascot/';

  const listHolder = $('#listHolder');
  const emptyState = $('#emptyState');
  const sumIncomeEl = $('#sumIncome');
  const sumExpenseEl = $('#sumExpense');
  const sumBalanceEl = $('#sumBalance');
  const chartEl = $('#chart');
  const chartTypeSel = $('#chartType');
  const chartModeSel = $('#chartMode');
  const chartLegend = $('#chartLegend');
  const mascotBalance = $('#mascotBalance');
  const mascotChart = $('#mascotChart');
  const balanceStatus = $('#balanceStatus');
  const txDateEl = $('#txDate');
  const filterMonthEl = $('#filterMonth');
  const txCountEl = $('#txCount');

  let chart;
  let gestureBound=false;
  let lastMascotPick=null;
  let lastTier=0;
  let bestTier=0;

  // ===== Storage helpers =====
  function load(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||[]}catch{return[]} }
  function save(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)) }

  // ===== Number format =====
  function vnNumberFormat(n){ return Number(n||0).toLocaleString('vi-VN'); }

  // ===== Settings =====
  function loadSettings(){
    const defaults = {
      thresholds: { t2: 5000000, t3: 10000000, t4: 20000000 },
      messages: {
        t0: 'üòø √Çm ({sign}{amount}). Th·ª≠ c·∫Øt gi·∫£m v√†i kho·∫£n kh√¥ng c·∫ßn thi·∫øt nh√©!',
        t1: 'üôÇ D∆∞ nh·∫π ({sign}{amount}). ƒê·∫∑t th√™m m·ª•c ti√™u ti·∫øt ki·ªám nh√©!',
        t2: 'ü§ë D∆∞ d·∫£ ({sign}{amount})! Ti·∫øp t·ª•c ti·∫øt ki·ªám th√¥ng minh!',
        t3: 'üöÄ Si√™u kh√° ({sign}{amount})! X·ªãn qu√°, duy tr√¨ ƒë√† n√†y!',
        t4: 'üëë ƒê·∫°i gia ({sign}{amount})! ƒê·∫∑t m·ª•c ti√™u ƒë·∫ßu t∆∞ d√†i h·∫°n nh√©!'
      },
      bestTier: 0
    };
    try{
      const got = JSON.parse(localStorage.getItem(SETTINGS_KEY)||'null');
      return got ? { ...defaults, ...got, thresholds: { ...defaults.thresholds, ...(got.thresholds||{}) }, messages: { ...defaults.messages, ...(got.messages||{}) } } : defaults;
    }catch{ return defaults }
  }
  function saveSettings(s){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }
  let SETTINGS = loadSettings();
  bestTier = SETTINGS.bestTier||0;

  // ===== Amount input =====
  const amountInput = $('#amount');
  if(amountInput){
    amountInput.addEventListener('input', ()=>{
      const digits = amountInput.value.replace(/\D/g, '');
      amountInput.value = digits ? Number(digits).toLocaleString('vi-VN') : '';
    });
  }
  function parseAmountField(){ const el=$('#amount'); return el? Number((el.value||'').replace(/\D/g,'')||0) : 0; }

  // ===== Date helpers =====
  const ymd = (ts)=>{ const d=new Date(ts); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` };
  const ym = (ts)=>{ const d=new Date(ts); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}` };
  function applyMonthFilter(arr){ const v = filterMonthEl? filterMonthEl.value: ''; if(!v) return arr; return arr.filter(t => ym(t.createdAt||Date.now()) === v); }

  // ===== Chart colors =====
  function palette(n){
    const base=['#b3261e','#2e7d32','#8B2E1A','#ff8f00','#1565c0','#6a1b9a','#00897b','#c2185b','#455a64','#ef6c00','#5d4037','#8e24aa','#43a047','#1e88e5'];
    const out=[]; for(let i=0;i<n;i++){ out.push(base[i%base.length]); } return out;
  }

  // ===== Mascot & status =====
  function updateMascots(income, expense){
    const balance = income - expense;
    const absFmt = vnNumberFormat(Math.abs(balance)) + 'ƒë';
    const sign = balance>0? '+': balance<0? '-': '';

    const { t2, t3, t4 } = SETTINGS.thresholds;
    let tier = 0; if(balance > 0) tier = 1; if(balance >= t2) tier = 2; if(balance >= t3) tier = 3; if(balance >= t4) tier = 4;

    let pick; let statusClass='status--neutral';
    if(tier>=2){ pick='tiger_rich.png'; statusClass='status--rich'; }
    else if(tier===1){ pick='tiger_income.png'; statusClass='status--neutral'; }
    else { pick='tiger_poor.png'; statusClass='status--poor'; }

    const msgMap = SETTINGS.messages;
    const templ = tier===4? msgMap.t4 : tier===3? msgMap.t3 : tier===2? msgMap.t2 : tier===1? msgMap.t1 : msgMap.t0;
    const message = templ.replace('{sign}', sign).replace('{amount}', absFmt);

    if(mascotBalance){
      if(pick !== lastMascotPick){
        mascotBalance.classList.remove('mascot-animate');
        void mascotBalance.offsetWidth;
        mascotBalance.classList.add('mascot-animate');
        lastMascotPick = pick;
      }
      mascotBalance.src = ASSET + pick;
    }
    if(balanceStatus){ balanceStatus.className = 'status-bar ' + statusClass; balanceStatus.textContent = message; }
    if(mascotChart){ mascotChart.src = ASSET + ((chartModeSel && chartModeSel.value==='byCategory') ? 'tiger_spending.png' : 'tiger_income.png'); }

    if(tier > lastTier){ fireConfetti(tier); }
    if(tier > bestTier){ bestTier = tier; SETTINGS.bestTier = tier; saveSettings(SETTINGS); showToast('üéâ K·ª∑ l·ª•c m·ªõi: Tier ' + tier); }
    lastTier = tier;
  }

  // ===== Render =====
  function render(){
    const up = load().map(t=>({...t, createdAt: t.createdAt || Date.now()})); save(up);
    const data = applyMonthFilter(up);
    let income=0, expense=0; listHolder.innerHTML='';
    emptyState.style.display = data.length? 'none':'flex';
    txCountEl.textContent = `${data.length} giao d·ªãch`;

    for(const t of data){
      if(t.type==='income') income+= +t.amount||0; else expense+= +t.amount||0;
      const row = document.createElement('div'); row.className='tx'; row.dataset.id=t.id;
      const left = document.createElement('div'); left.innerHTML = '<div class="date">'+ymd(t.createdAt)+'</div><div class="cat">'+(t.category||'Kh√°c')+'</div>';
      const amt = document.createElement('div'); amt.className = 'amt ' + (t.type==='income'?'in':'out'); amt.textContent = (t.type==='income'?'+':'-') + vnNumberFormat(t.amount) + 'ƒë';
      const del = document.createElement('button'); del.className='btn danger'; del.textContent='X'; del.onclick=()=>removeOne(t.id);
      row.appendChild(left); row.appendChild(amt); row.appendChild(del); listHolder.appendChild(row);
    }
    sumIncomeEl.textContent = vnNumberFormat(income)+'ƒë'; sumExpenseEl.textContent = vnNumberFormat(expense)+'ƒë'; sumBalanceEl.textContent = vnNumberFormat(income-expense)+'ƒë';
    updateMascots(income, expense);
    renderChart(data, income, expense);
    bindGestures();
  }

  // ===== Chart =====
  function renderChart(data, income, expense){
    if(!chartEl || typeof Chart === 'undefined') return;
    if(chart){ try{ chart.destroy(); }catch(e){} }

    const type = (chartTypeSel && chartTypeSel.value) || 'doughnut';
    const mode = (chartModeSel && chartModeSel.value) || 'byCategory';
    let labels=[], values=[], legendText='';
    if(mode==='totals'){ labels=['Thu','Chi']; values=[income, expense]; legendText='T·ªïng h·ª£p thu/chi'; }
    else { const map=new Map(); for(const t of data){ if(t.type!=='expense') continue; const k=t.category||'Kh√°c'; map.set(k,(map.get(k)||0)+(+t.amount||0)); } labels=[...map.keys()]; values=[...map.values()]; legendText='Chi ti√™u theo danh m·ª•c'; }

    const total = values.reduce((a,b)=>a+b,0);
    if(values.length===0 || total===0){ labels=['Kh√¥ng c√≥ d·ªØ li·ªáu']; values=[0.0001]; }

    const colors = palette(values.length||2);
    const dataset = { label: legendText, data: values, backgroundColor: (type==='doughnut' || type==='bar')? colors: undefined, borderColor: type==='line'? colors: undefined, fill: type==='line'? false: undefined, borderWidth:2, tension: type==='line'? .3: undefined };
    chart = new Chart(chartEl,{ type, data:{labels, datasets:[dataset]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:type==='doughnut'?'bottom':'top' }}, scales:(type==='bar'||type==='line')?{ y:{ beginAtZero:true } }:undefined }});
    if(chartLegend) chartLegend.textContent = legendText;
  }

  // ===== Gestures =====
  function bindGestures(){ /* swipe-to-delete gi·ªØ nguy√™n */ }

  // ===== CRUD =====
  function removeOne(id){ const data = load().filter(t=>t.id!==id); save(data); render(); }
  function editOne(id){ /* gi·ªØ nguy√™n code edit */ }
  function add(){
    const amount=parseAmountField(); const type=$('#type')?$('#type').value:'expense'; const category=$('#category')?($('#category').value||'').trim():''; const note=$('#note')?($('#note').value||'').trim():''; const dateVal=txDateEl?txDateEl.value:'';
    if(!amount){ alert('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá'); return }
    const createdAt = dateVal ? new Date(dateVal + 'T00:00:00').getTime() : Date.now();
    const data = load(); data.unshift({ id: crypto.randomUUID(), amount, type, category, note, createdAt });
    save(data); if($('#amount')) $('#amount').value=''; if($('#category')) $('#category').value=''; if($('#note')) $('#note').value=''; render();
  }
  function clearAll(){
    if(!confirm('X√≥a t·∫•t c·∫£ giao d·ªãch?')) return;
    try{ localStorage.setItem(STORAGE_KEY,'[]'); }catch(e){ localStorage.removeItem(STORAGE_KEY); }
    lastTier=0; render(); showToast('ƒê√£ x√≥a t·∫•t c·∫£');
  }

  // ===== Toast =====
  function showToast(text){ const t=$('#appToast'); if(!t) return; t.textContent=text; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200); }

  // ===== Confetti =====
  function fireConfetti(level){ /* code confetti gi·ªØ nguy√™n */ }

  // ===== Events =====
  if($('#add')) $('#add').addEventListener('click', add);
  if($('#clearAll')) $('#clearAll').addEventListener('click', clearAll);
  if($('#clearAll2')) $('#clearAll2').addEventListener('click', clearAll);
  if(chartTypeSel) chartTypeSel.addEventListener('change', ()=>{ render(); });
  if(chartModeSel) chartModeSel.addEventListener('change', ()=>{ render(); });
  if(filterMonthEl) filterMonthEl.addEventListener('change', render);

  (function init(){
    const today=new Date(); const yyyy=today.getFullYear(); const mm=String(today.getMonth()+1).padStart(2,'0'); const dd=String(today.getDate()).padStart(2,'0');
    if($('#txDate')) $('#txDate').value = `${yyyy}-${mm}-${dd}`; if(filterMonthEl) filterMonthEl.value = `${yyyy}-${mm}`; render();
  })();
</script>
  </script>
</body>
</html>
